#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Hook de prÃ©-push usando Husky para projeto React Native VetApp
echo "ğŸš€ Executando verificaÃ§Ãµes de prÃ©-push com Husky..."

# Verificar se hÃ¡ commits para fazer push
if git diff --quiet HEAD @{u} 2>/dev/null; then
    echo "âœ… Nenhum commit novo para enviar"
    exit 0
fi

# Obter branch atual
current_branch=$(git branch --show-current)
echo "ğŸ“ Branch atual: $current_branch"

# Verificar branches protegidas
protected_branches="main master production release"
if echo "$protected_branches" | grep -wq "$current_branch"; then
    echo "âš ï¸  Push para branch protegida: $current_branch"
    echo "Confirma o push? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        echo "âŒ Push cancelado"
        exit 1
    fi
fi

# Verificar se hÃ¡ mudanÃ§as nÃ£o commitadas
if ! git diff-index --quiet HEAD --; then
    echo "âŒ HÃ¡ mudanÃ§as nÃ£o commitadas. FaÃ§a commit antes do push."
    exit 1
fi

# Executar testes se existirem
if [ -f "package.json" ]; then
    echo "ğŸ§ª Verificando testes..."
    
    # Verificar se hÃ¡ script de teste
    if grep -q '"test"' package.json && ! grep -q '"test".*"echo.*no test"' package.json; then
        echo "Executando testes..."
        npm test || {
            echo "âŒ Testes falharam"
            exit 1
        }
        echo "âœ… Testes passaram"
    else
        echo "â„¹ï¸  Nenhum teste configurado"
    fi
    
    # Executar lint se disponÃ­vel
    if grep -q '"lint"' package.json; then
        echo "ğŸ”§ Executando lint..."
        npm run lint || {
            echo "âŒ Lint falhou"
            exit 1
        }
        echo "âœ… Lint passou"
    fi
fi

# Verificar build para React Native
echo "ğŸ”¨ Verificando integridade do projeto React Native..."

# Verificar sintaxe dos arquivos principais
main_files="App.js index.js"
for file in $main_files; do
    if [ -f "$file" ]; then
        node -c "$file" || {
            echo "âŒ Erro de sintaxe em: $file"
            exit 1
        }
    fi
done

# Verificar imports e dependÃªncias
echo "ğŸ“¦ Verificando dependÃªncias..."

# Verificar se package-lock.json estÃ¡ atualizado
if [ -f "package-lock.json" ]; then
    if [ "package.json" -nt "package-lock.json" ]; then
        echo "âš ï¸  package-lock.json desatualizado. Execute 'npm install'"
    fi
fi

# Verificar se nÃ£o hÃ¡ dependÃªncias nÃ£o utilizadas (verificaÃ§Ã£o bÃ¡sica)
if command -v npx >/dev/null 2>&1; then
    if [ -f "package.json" ]; then
        # Verificar imports de dependÃªncias principais
        react_imports=$(find src -name "*.js" -o -name "*.jsx" | xargs grep -l "import.*react" 2>/dev/null | wc -l)
        if [ "$react_imports" -eq 0 ] && grep -q '"react"' package.json; then
            echo "âš ï¸  React listado como dependÃªncia mas nÃ£o parece ser usado"
        fi
    fi
fi

# Verificar arquivos de configuraÃ§Ã£o especÃ­ficos do React Native
echo "âš™ï¸  Verificando configuraÃ§Ãµes React Native..."

# Verificar metro.config.js
if [ -f "metro.config.js" ]; then
    node -c metro.config.js || {
        echo "âŒ Erro em metro.config.js"
        exit 1
    }
fi

# Verificar configuraÃ§Ã£o do babel
if [ -f "babel.config.js" ]; then
    node -c babel.config.js || {
        echo "âŒ Erro em babel.config.js"
        exit 1
    }
fi

# Verificar se nÃ£o hÃ¡ console.log em arquivos de produÃ§Ã£o
echo "ğŸš« Verificando console.log em produÃ§Ã£o..."
production_logs=$(find src -name "*.js" -o -name "*.jsx" | xargs grep -l "console\.log" 2>/dev/null || true)

if [ ! -z "$production_logs" ]; then
    echo "âš ï¸  console.log encontrados em:"
    echo "$production_logs"
    echo "Considere remover para produÃ§Ã£o"
fi

# Verificar tamanho do bundle (estimativa)
echo "ğŸ“Š Verificando tamanho estimado..."
total_js_size=$(find src -name "*.js" -o -name "*.jsx" | xargs wc -c 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
total_js_mb=$((total_js_size / 1048576))

if [ "$total_js_mb" -gt 5 ]; then
    echo "âš ï¸  CÃ³digo JavaScript muito grande: ${total_js_mb}MB"
    echo "Considere otimizaÃ§Ãµes ou code splitting"
fi

# Verificar credenciais e configuraÃ§Ãµes sensÃ­veis
echo "ğŸ”’ Verificando seguranÃ§a..."

# Verificar se nÃ£o hÃ¡ URLs de desenvolvimento em produÃ§Ã£o
dev_urls=$(find src -name "*.js" -o -name "*.jsx" | xargs grep -i "localhost\|127.0.0.1\|192.168" 2>/dev/null || true)

if [ ! -z "$dev_urls" ]; then
    echo "âš ï¸  URLs de desenvolvimento encontradas:"
    echo "$dev_urls"
    echo "Verifique se sÃ£o apropriadas para produÃ§Ã£o"
fi

# Verificar configuraÃ§Ã£o do Supabase
if [ -f "src/config/supabase.js" ]; then
    echo "ğŸ”§ Verificando configuraÃ§Ã£o do Supabase..."
    
    if grep -q "localhost" src/config/supabase.js; then
        echo "âš ï¸  ConfiguraÃ§Ã£o do Supabase aponta para localhost"
    fi
    
    # Verificar se as chaves nÃ£o estÃ£o hardcoded
    if grep -q "supabaseAnonKey.*eyJ" src/config/supabase.js; then
        echo "âœ… Chave do Supabase configurada"
    fi
fi

# Verificar estrutura de pastas e arquivos essenciais
echo "ğŸ“ Verificando estrutura do projeto..."

essential_files="App.js package.json"
for file in $essential_files; do
    if [ ! -f "$file" ]; then
        echo "âŒ Arquivo essencial ausente: $file"
        exit 1
    fi
done

essential_dirs="src src/components src/screens src/services"
for dir in $essential_dirs; do
    if [ ! -d "$dir" ]; then
        echo "âš ï¸  DiretÃ³rio essencial ausente: $dir"
    fi
done

# Verificar commits recentes
echo "ğŸ“ Analisando commits para push..."
commits_count=$(git rev-list HEAD --not --remotes 2>/dev/null | wc -l)
echo "Commits para enviar: $commits_count"

if [ "$commits_count" -gt 15 ]; then
    echo "âš ï¸  Muitos commits ($commits_count). Considere squash"
fi

# Verificar qualidade das mensagens de commit
echo "Verificando mensagens de commit..."
git rev-list HEAD --not --remotes 2>/dev/null | head -5 | while read commit; do
    msg=$(git log --format=%s -n 1 "$commit")
    if [ ${#msg} -lt 10 ]; then
        echo "âš ï¸  Mensagem muito curta: $msg"
    fi
    
    # Verificar padrÃ£o conventional commits
    if ! echo "$msg" | grep -Eq '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
        echo "âš ï¸  Mensagem nÃ£o segue padrÃ£o conventional: $msg"
    fi
done

# Verificar configuraÃ§Ã£o do usuÃ¡rio git
echo "ğŸ‘¤ Verificando configuraÃ§Ã£o do git..."
git_user=$(git config user.name)
git_email=$(git config user.email)

if [ -z "$git_user" ] || [ -z "$git_email" ]; then
    echo "âŒ ConfiguraÃ§Ã£o do git incompleta"
    exit 1
fi

# Verificar se Ã© um merge commit
merge_commit=$(git rev-list HEAD --not --remotes --merges 2>/dev/null | head -1)
if [ ! -z "$merge_commit" ]; then
    echo "ğŸ”€ Merge commit detectado"
fi

# Log do push
echo "ğŸ“ Registrando push..."
{
    echo "$(date '+%Y-%m-%d %H:%M:%S'): Push de $current_branch"
    echo "  Commits: $commits_count"
    echo "  UsuÃ¡rio: $git_user <$git_email>"
    echo "---"
} >> .git/push_history.log

echo "âœ… Todas as verificaÃ§Ãµes de prÃ©-push do Husky passaram!"
echo "ğŸ¯ Prosseguindo com o push..."
