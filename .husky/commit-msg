#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Hook de mensagem de commit usando Husky para projeto React Native VetApp
echo "ğŸ“ Validando mensagem de commit com Husky..."

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
first_line=$(echo "$commit_msg" | head -n1)

# Regex para Conventional Commits
commit_regex='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}'

# Verificar se nÃ£o estÃ¡ vazia
if [ -z "$commit_msg" ]; then
    echo "âŒ Mensagem de commit vazia"
    exit 1
fi

# Verificar tamanho da primeira linha
if [ ${#first_line} -gt 72 ]; then
    echo "âŒ Primeira linha muito longa (${#first_line} chars). MÃ¡ximo: 72"
    echo "Linha: $first_line"
    exit 1
fi

if [ ${#first_line} -lt 10 ]; then
    echo "âŒ Primeira linha muito curta (${#first_line} chars). MÃ­nimo: 10"
    echo "Linha: $first_line"
    exit 1
fi

# Verificar formato Conventional Commits
if ! echo "$first_line" | grep -Eq "$commit_regex"; then
    echo "âŒ Formato invÃ¡lido! Use: tipo(escopo): descriÃ§Ã£o"
    echo ""
    echo "ğŸ“‹ Tipos vÃ¡lidos:"
    echo "  feat:     Nova funcionalidade"
    echo "  fix:      CorreÃ§Ã£o de bug"
    echo "  docs:     DocumentaÃ§Ã£o"
    echo "  style:    FormataÃ§Ã£o, estilo"
    echo "  refactor: RefatoraÃ§Ã£o"
    echo "  test:     Testes"
    echo "  chore:    ManutenÃ§Ã£o"
    echo "  perf:     Performance"
    echo "  ci:       CI/CD"
    echo "  build:    Build"
    echo "  revert:   Reverter"
    echo ""
    echo "âœ… Exemplos vÃ¡lidos:"
    echo "  feat(auth): adicionar login social"
    echo "  fix(pets): corrigir validaÃ§Ã£o de dados"
    echo "  docs(readme): atualizar instruÃ§Ãµes"
    echo "  refactor(agenda): reorganizar componentes"
    echo ""
    echo "âŒ Sua mensagem: $first_line"
    exit 1
fi

# Verificar se descriÃ§Ã£o comeÃ§a com minÃºscula
description=$(echo "$first_line" | sed 's/^[^:]*: *//')
first_char=$(echo "$description" | cut -c1)

if ! echo "$first_char" | grep -q '[a-z]'; then
    echo "âš ï¸  RecomendaÃ§Ã£o: use minÃºscula apÃ³s os dois pontos"
    echo "Exemplo: 'feat: adicionar funcionalidade' âœ…"
    echo "Evite: 'feat: Adicionar funcionalidade' âŒ"
fi

# Verificar se termina com ponto
if echo "$first_line" | grep -q '\.$'; then
    echo "âš ï¸  RecomendaÃ§Ã£o: nÃ£o termine com ponto"
fi

# Verificar palavras nÃ£o recomendadas
if echo "$description" | grep -iq '\b(corrigir|arrumei|bugfix|consertei)\b'; then
    echo "âš ï¸  Evite palavras genÃ©ricas. Seja especÃ­fico sobre a mudanÃ§a"
fi

# Verificar escopos especÃ­ficos do projeto VetApp
commit_type=$(echo "$first_line" | sed 's/\([^(]*\).*/\1/')
commit_scope=$(echo "$first_line" | sed -n 's/[^(]*(\([^)]*\)).*/\1/p')

# Validar escopos conhecidos
valid_scopes="auth login perfil pets animais agenda consultas biblioteca medicamentos backup dados ui interface database supabase navigation components services utils"

if [ ! -z "$commit_scope" ]; then
    if ! echo "$valid_scopes" | grep -wq "$commit_scope"; then
        echo "âš ï¸  Escopo '$commit_scope' nÃ£o Ã© padrÃ£o do projeto"
        echo "ğŸ“‹ Escopos recomendados: auth, pets, agenda, biblioteca, backup, ui, database"
    fi
fi

# Verificar se hÃ¡ segunda linha vazia
second_line=$(echo "$commit_msg" | sed -n '2p')
if [ ! -z "$second_line" ]; then
    echo "âš ï¸  Deixe a segunda linha vazia (entre tÃ­tulo e corpo)"
fi

# Validar corpo da mensagem se existir
line_count=$(echo "$commit_msg" | wc -l)
if [ "$line_count" -gt 2 ]; then
    echo "âœ… Mensagem com corpo detalhado"
    
    # Verificar linhas do corpo
    echo "$commit_msg" | tail -n +3 | while IFS= read -r line; do
        if [ ${#line} -gt 72 ]; then
            echo "âš ï¸  Linha do corpo muito longa: $line"
        fi
    done
    
    # Verificar se o corpo adiciona valor
    body=$(echo "$commit_msg" | tail -n +3 | tr '\n' ' ')
    if [ ${#body} -lt 20 ]; then
        echo "âš ï¸  Corpo muito curto. Adicione mais contexto"
    fi
fi

# VerificaÃ§Ãµes especÃ­ficas por tipo de commit
case "$commit_type" in
    "feat")
        echo "ğŸ‰ Nova funcionalidade!"
        echo "ğŸ’¡ Lembrete:"
        echo "  - Testes foram adicionados?"
        echo "  - Interface estÃ¡ acessÃ­vel?"
        echo "  - DocumentaÃ§Ã£o foi atualizada?"
        ;;
    "fix")
        echo "ğŸ› CorreÃ§Ã£o de bug!"
        echo "ğŸ’¡ Lembrete:"
        echo "  - O problema foi reproduzido?"
        echo "  - NÃ£o causou regressÃµes?"
        echo "  - Teste de edge cases?"
        ;;
    "refactor")
        echo "â™»ï¸  RefatoraÃ§Ã£o!"
        echo "ğŸ’¡ Lembrete:"
        echo "  - Comportamento permanece igual?"
        echo "  - Performance nÃ£o foi degradada?"
        ;;
    "perf")
        echo "âš¡ Melhoria de performance!"
        echo "ğŸ’¡ Lembrete:"
        echo "  - Mediu a melhoria?"
        echo "  - NÃ£o quebrou funcionalidades?"
        ;;
    "test")
        echo "ğŸ§ª Testes!"
        echo "ğŸ’¡ Lembrete:"
        echo "  - Cobertura aumentou?"
        echo "  - Testes sÃ£o relevantes?"
        ;;
esac

# VerificaÃ§Ãµes especÃ­ficas por escopo
case "$commit_scope" in
    "auth"|"login")
        echo "ğŸ” Commit de autenticaÃ§Ã£o"
        echo "âš ï¸  Verificar: seguranÃ§a, tokens, validaÃ§Ãµes"
        ;;
    "pets"|"animais")
        echo "ğŸ¾ Commit relacionado aos pets"
        echo "âš ï¸  Verificar: validaÃ§Ãµes de dados, relacionamentos"
        ;;
    "agenda"|"consultas")
        echo "ğŸ“… Commit da agenda"
        echo "âš ï¸  Verificar: datas, conflitos, notificaÃ§Ãµes"
        ;;
    "database"|"supabase")
        echo "ğŸ—„ï¸  Commit de banco de dados"
        echo "âš ï¸  CUIDADO: migrations, dados sensÃ­veis, backup"
        ;;
    "ui"|"interface")
        echo "ğŸ¨ Commit de interface"
        echo "âš ï¸  Verificar: responsividade, acessibilidade"
        ;;
esac

# Detectar possÃ­veis breaking changes
if echo "$commit_msg" | grep -qi "breaking\|major\|remove\|delete"; then
    echo "ğŸ’¥ POSSÃVEL BREAKING CHANGE detectado!"
    echo "Use 'feat!:' ou 'fix!:' para marcar breaking changes"
fi

# Verificar referÃªncias a issues/PRs
if echo "$commit_msg" | grep -q "#[0-9]"; then
    echo "ğŸ”— ReferÃªncia a issue/PR detectada"
fi

# EstatÃ­sticas
echo ""
echo "ğŸ“Š EstatÃ­sticas do commit:"
echo "  Tipo: $commit_type"
if [ ! -z "$commit_scope" ]; then
    echo "  Escopo: $commit_scope"
fi
echo "  Tamanho: ${#commit_msg} caracteres"
echo "  Linhas: $line_count"

# Salvar estatÃ­sticas para anÃ¡lise
stats_file=".git/husky_commit_stats.json"
timestamp=$(date '+%Y-%m-%d %H:%M:%S')

# Criar ou atualizar arquivo de estatÃ­sticas
if [ ! -f "$stats_file" ]; then
    echo "[]" > "$stats_file"
fi

# Adicionar entrada (formato JSON simples)
{
    echo "{"
    echo "  \"timestamp\": \"$timestamp\","
    echo "  \"type\": \"$commit_type\","
    echo "  \"scope\": \"$commit_scope\","
    echo "  \"message_length\": ${#commit_msg},"
    echo "  \"line_count\": $line_count"
    echo "},"
} >> .git/temp_commit_entry.json

# SugestÃµes de melhoria baseadas no padrÃ£o
if [ -z "$commit_scope" ] && [ "$commit_type" != "docs" ] && [ "$commit_type" != "chore" ]; then
    echo ""
    echo "ğŸ’¡ SugestÃ£o: adicione um escopo para melhor organizaÃ§Ã£o"
    echo "Exemplo: $commit_type(pets): $description"
fi

# Verificar frequÃªncia do tipo de commit
type_count=$(grep "\"type\": \"$commit_type\"" .git/husky_commit_stats.json 2>/dev/null | wc -l || echo "0")
if [ "$type_count" -gt 10 ]; then
    echo "ğŸ“ˆ Tipo '$commit_type' usado $type_count vezes recentemente"
fi

echo ""
echo "âœ… Mensagem de commit vÃ¡lida!"
echo "ğŸ¯ Aplicando padrÃµes de qualidade do VetApp"
