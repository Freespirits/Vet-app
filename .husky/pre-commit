#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Hook de pr√©-commit usando Husky para projeto React Native VetApp
echo "üîç Executando verifica√ß√µes de pr√©-commit com Husky..."

# Verificar se h√° arquivos no stage
if git diff --cached --quiet; then
    echo "‚ùå Nenhum arquivo foi adicionado ao stage. Use 'git add' primeiro."
    exit 1
fi

# Executar lint se estiver configurado
if command -v npx >/dev/null 2>&1; then
    if [ -f "package.json" ] && grep -q '"lint"' package.json; then
        echo "üîß Executando lint..."
        npx lint-staged 2>/dev/null || {
            echo "‚ö†Ô∏è  Lint-staged n√£o configurado, executando verifica√ß√µes b√°sicas..."
        }
    fi
fi

# Verificar arquivos JavaScript/TypeScript
echo "üìù Verificando arquivos JavaScript/TypeScript..."
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ ! -z "$staged_files" ]; then
    for file in $staged_files; do
        if [ -f "$file" ]; then
            # Verifica√ß√£o de sintaxe
            node -c "$file" 2>/dev/null || {
                echo "‚ùå Erro de sintaxe em: $file"
                exit 1
            }
            
            # Verificar console.log
            if grep -q "console\.log" "$file"; then
                echo "‚ö†Ô∏è  console.log encontrado em: $file"
                echo "Considere remover ou usar // eslint-disable-next-line"
            fi
        fi
    done
    echo "‚úÖ Arquivos JavaScript verificados"
fi

# Verificar package.json se foi modificado
if git diff --cached --name-only | grep -q "package.json"; then
    echo "üì¶ Verificando package.json..."
    
    # Verificar se √© v√°lido JSON
    if ! python -m json.tool package.json >/dev/null 2>&1 && ! node -e "JSON.parse(require('fs').readFileSync('package.json'))" 2>/dev/null; then
        echo "‚ùå package.json inv√°lido"
        exit 1
    fi
    
    echo "‚úÖ package.json v√°lido"
fi

# Verificar arquivos de configura√ß√£o do React Native
echo "‚öôÔ∏è  Verificando configura√ß√µes do React Native..."

# Verificar metro.config.js se existir
if [ -f "metro.config.js" ] && git diff --cached --name-only | grep -q "metro.config.js"; then
    node -c metro.config.js || {
        echo "‚ùå Erro de sintaxe em metro.config.js"
        exit 1
    }
fi

# Verificar App.js principal
if git diff --cached --name-only | grep -q "App.js"; then
    echo "üîç Verificando App.js principal..."
    node -c App.js || {
        echo "‚ùå Erro de sintaxe no App.js"
        exit 1
    }
fi

# Verificar imports n√£o utilizados (verifica√ß√£o b√°sica)
if [ ! -z "$staged_files" ]; then
    echo "üìã Verificando imports..."
    for file in $staged_files; do
        if [ -f "$file" ]; then
            # Verificar imports que podem estar n√£o utilizados
            unused_react=$(grep "import React" "$file" | head -1)
            if [ ! -z "$unused_react" ] && ! grep -q "React\." "$file" && ! grep -q "<" "$file"; then
                echo "‚ö†Ô∏è  Poss√≠vel import n√£o utilizado do React em: $file"
            fi
        fi
    done
fi

# Verificar se h√° mudan√ßas em arquivos de configura√ß√£o cr√≠ticos
config_files=$(git diff --cached --name-only | grep -E "(\.env|supabase\.js|config/)" || true)
if [ ! -z "$config_files" ]; then
    echo "üîß Mudan√ßas em arquivos de configura√ß√£o detectadas:"
    echo "$config_files"
    
    # Verificar se n√£o h√° credenciais expostas
    for file in $config_files; do
        if [ -f "$file" ] && grep -qi "password\|secret\|key.*=" "$file"; then
            echo "‚ùå Poss√≠veis credenciais expostas em: $file"
            echo "Use vari√°veis de ambiente em vez de hardcode"
            exit 1
        fi
    done
fi

# Verificar tamanho dos arquivos
echo "üìè Verificando tamanho dos arquivos..."
large_files=$(git diff --cached --name-only --diff-filter=ACM | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9, "(" $5/1048576 "MB)"}' || true)

if [ ! -z "$large_files" ]; then
    echo "‚ö†Ô∏è  Arquivos grandes detectados (>1MB):"
    echo "$large_files"
    echo "Considere otimizar ou usar Git LFS"
fi

# Executar Prettier se estiver dispon√≠vel
if command -v npx >/dev/null 2>&1 && [ -f ".prettierrc" ] || [ -f "prettier.config.js" ]; then
    echo "üíÖ Executando Prettier..."
    if [ ! -z "$staged_files" ]; then
        npx prettier --check $staged_files 2>/dev/null || {
            echo "‚ö†Ô∏è  Arquivos n√£o est√£o formatados com Prettier"
            echo "Execute: npx prettier --write [arquivos]"
        }
    fi
fi

# Verificar se h√° TODOs ou FIXMEs
echo "üìù Verificando TODOs e FIXMEs..."
todos=$(git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" || true)

if [ ! -z "$todos" ]; then
    echo "üìã TODOs/FIXMEs encontrados:"
    echo "$todos"
fi

# Verificar estrutura de pastas do projeto React Native
echo "üìÅ Verificando estrutura do projeto..."

# Verificar se pastas essenciais existem
essential_dirs="src src/components src/screens src/services"
for dir in $essential_dirs; do
    if [ ! -d "$dir" ]; then
        echo "‚ö†Ô∏è  Pasta essencial n√£o encontrada: $dir"
    fi
done

# Verificar se os arquivos de servi√ßo est√£o sendo usados corretamente
service_files=$(git diff --cached --name-only | grep "src/services/" || true)
if [ ! -z "$service_files" ]; then
    echo "üîß Verificando arquivos de servi√ßo..."
    for file in $service_files; do
        if [ -f "$file" ]; then
            # Verificar se exporta default ou named exports
            if ! grep -q "export" "$file"; then
                echo "‚ö†Ô∏è  Arquivo de servi√ßo sem exports: $file"
            fi
        fi
    done
fi

echo "‚úÖ Verifica√ß√µes de pr√©-commit do Husky conclu√≠das!"
