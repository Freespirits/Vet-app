#!/bin/sh

# Hook de prÃ©-commit para projeto React Native VetApp
# Executa verificaÃ§Ãµes de qualidade antes do commit

echo "ğŸ” Executando verificaÃ§Ãµes de prÃ©-commit..."

# Verificar se existem arquivos staged
if git diff --cached --quiet; then
    echo "âŒ Nenhum arquivo foi adicionado ao stage. Use 'git add' primeiro."
    exit 1
fi

# Verificar sintaxe JavaScript/TypeScript
echo "ğŸ“ Verificando sintaxe JavaScript..."
staged_js_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ ! -z "$staged_js_files" ]; then
    echo "Arquivos JS/TS encontrados: $staged_js_files"
    
    # Verificar se hÃ¡ erros de sintaxe nos arquivos JS
    for file in $staged_js_files; do
        if [ -f "$file" ]; then
            # VerificaÃ§Ã£o bÃ¡sica de sintaxe com node
            node -c "$file" 2>/dev/null || {
                echo "âŒ Erro de sintaxe encontrado em: $file"
                exit 1
            }
        fi
    done
    echo "âœ… Sintaxe JavaScript verificada"
fi

# Verificar se nÃ£o hÃ¡ console.log em produÃ§Ã£o
echo "ğŸš« Verificando console.log..."
forbidden_logs=$(git diff --cached --name-only --diff-filter=ACM | xargs grep -l "console\.log" 2>/dev/null || true)

if [ ! -z "$forbidden_logs" ]; then
    echo "âŒ Encontrados console.log nos seguintes arquivos:"
    echo "$forbidden_logs"
    echo "Remova os console.log antes do commit ou use // eslint-disable-next-line"
    exit 1
fi
echo "âœ… Nenhum console.log encontrado"

# Verificar se nÃ£o hÃ¡ cÃ³digos de debug
echo "ğŸ› Verificando cÃ³digos de debug..."
debug_code=$(git diff --cached --name-only --diff-filter=ACM | xargs grep -l "debugger\|console\.error\|console\.warn" 2>/dev/null || true)

if [ ! -z "$debug_code" ]; then
    echo "âš ï¸  CÃ³digos de debug encontrados nos seguintes arquivos:"
    echo "$debug_code"
    echo "Revise se Ã© necessÃ¡rio manter esses cÃ³digos"
fi

# Verificar estrutura de arquivos crÃ­ticos
echo "ğŸ“ Verificando estrutura de arquivos..."

# Verificar se arquivos essenciais nÃ£o foram removidos
essential_files="App.js package.json"
for file in $essential_files; do
    if [ ! -f "$file" ]; then
        echo "âŒ Arquivo essencial removido: $file"
        exit 1
    fi
done

# Verificar se hÃ¡ mudanÃ§as em arquivos de configuraÃ§Ã£o sensÃ­veis
config_files=$(git diff --cached --name-only | grep -E "(supabase\.js|\.env)" || true)
if [ ! -z "$config_files" ]; then
    echo "âš ï¸  MudanÃ§as em arquivos de configuraÃ§Ã£o detectadas:"
    echo "$config_files"
    echo "Certifique-se de que nÃ£o hÃ¡ informaÃ§Ãµes sensÃ­veis expostas"
fi

# Verificar tamanho dos arquivos
echo "ğŸ“ Verificando tamanho dos arquivos..."
large_files=$(git diff --cached --name-only --diff-filter=ACM | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9, $5}' || true)

if [ ! -z "$large_files" ]; then
    echo "âš ï¸  Arquivos grandes detectados (>1MB):"
    echo "$large_files"
    echo "Considere otimizar ou usar Git LFS para arquivos grandes"
fi

# Verificar imports nÃ£o utilizados (verificaÃ§Ã£o bÃ¡sica)
echo "ğŸ“¦ Verificando imports..."
unused_imports=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$' | xargs grep -l "^import.*from.*'[^']*'.*$" 2>/dev/null | head -5 || true)

if [ ! -z "$unused_imports" ]; then
    echo "ğŸ“‹ Verificando imports nos arquivos principais..."
    # Esta Ã© uma verificaÃ§Ã£o bÃ¡sica - em projetos maiores use ESLint
fi

# Verificar se hÃ¡ funÃ§Ãµes muito grandes (>50 linhas)
echo "ğŸ” Verificando tamanho das funÃ§Ãµes..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$' | while read file; do
    if [ -f "$file" ]; then
        # Contar linhas entre function e }
        large_functions=$(awk '
            /function.*{/ { start=NR; depth=1; next }
            depth > 0 { 
                gsub(/[^{}]/, ""); 
                depth += gsub(/{/, "") - gsub(/}/, "")
                if (depth == 0 && NR - start > 50) 
                    print FILENAME ":" start "-" NR " (funÃ§Ã£o muito grande: " (NR-start) " linhas)"
            }
        ' "$file" 2>/dev/null || true)
        
        if [ ! -z "$large_functions" ]; then
            echo "âš ï¸  $large_functions"
        fi
    fi
done

# Verificar se hÃ¡ TODOs ou FIXMEs
echo "ğŸ“ Verificando TODOs e FIXMEs..."
todos=$(git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" || true)

if [ ! -z "$todos" ]; then
    echo "ğŸ“‹ TODOs/FIXMEs encontrados:"
    echo "$todos"
    echo "Considere resolver ou documentar melhor essas pendÃªncias"
fi

# Verificar mensagem de commit (se houver)
if [ -f ".git/COMMIT_EDITMSG" ]; then
    commit_msg=$(cat .git/COMMIT_EDITMSG | head -1)
    if [ ${#commit_msg} -lt 10 ]; then
        echo "âŒ Mensagem de commit muito curta. Use pelo menos 10 caracteres."
        exit 1
    fi
fi

echo "âœ… Todas as verificaÃ§Ãµes de prÃ©-commit passaram!"
echo "ğŸš€ Prosseguindo com o commit..."

exit 0
