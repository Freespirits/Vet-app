#!/bin/sh
# Git hook pre-push para PetCare Pro
# Executa verifica√ß√µes antes de push para reposit√≥rio remoto

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fun√ß√£o para logging
log_info() {
    echo "${BLUE}[PRE-PUSH]${NC} $1"
}

log_success() {
    echo "${GREEN}[PRE-PUSH]${NC} ‚úì $1"
}

log_warning() {
    echo "${YELLOW}[PRE-PUSH]${NC} ‚ö† $1"
}

log_error() {
    echo "${RED}[PRE-PUSH]${NC} ‚úó $1"
}

# Fun√ß√£o para verificar se comando existe
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Verificar se estamos em um reposit√≥rio Git
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "N√£o est√° em um reposit√≥rio Git"
    exit 1
fi

log_info "Iniciando verifica√ß√µes pr√©-push..."

# ==============================================================================
# VERIFICA√á√ïES B√ÅSICAS
# ==============================================================================

# Verificar se Node.js est√° instalado
if ! command_exists node; then
    log_error "Node.js n√£o est√° instalado"
    exit 1
fi

# Verificar se npm est√° instalado
if ! command_exists npm; then
    log_error "NPM n√£o est√° instalado"
    exit 1
fi

# Verificar se package.json existe
if [ ! -f "package.json" ]; then
    log_error "package.json n√£o encontrado"
    exit 1
fi

# ==============================================================================
# VERIFICAR BRANCH ATUAL
# ==============================================================================

current_branch=$(git branch --show-current)
log_info "Branch atual: $current_branch"

# Verificar se est√° tentando fazer push diretamente para main
if [ "$current_branch" = "main" ]; then
    log_warning "Push direto para branch main detectado"
    echo "${YELLOW}Voc√™ tem certeza que deseja fazer push diretamente para main?${NC}"
    echo "Recomendamos usar Pull Requests para mudan√ßas em main."
    read -p "Continuar? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Push cancelado pelo usu√°rio"
        exit 1
    fi
fi

# ==============================================================================
# VERIFICAR STATUS DO REPOSIT√ìRIO
# ==============================================================================

# Verificar se h√° arquivos n√£o commitados
if ! git diff --quiet; then
    log_error "H√° arquivos modificados n√£o commitados"
    log_info "Execute 'git add .' e 'git commit' antes do push"
    exit 1
fi

# Verificar se h√° arquivos staged n√£o commitados
if ! git diff --cached --quiet; then
    log_error "H√° arquivos staged n√£o commitados"
    log_info "Execute 'git commit' antes do push"
    exit 1
fi

log_success "Status do reposit√≥rio OK"

# ==============================================================================
# VERIFICAR DEPEND√äNCIAS
# ==============================================================================

log_info "Verificando depend√™ncias..."

# Verificar se node_modules existe
if [ ! -d "node_modules" ]; then
    log_warning "node_modules n√£o encontrado. Instalando depend√™ncias..."
    npm ci
    if [ $? -ne 0 ]; then
        log_error "Falha ao instalar depend√™ncias"
        exit 1
    fi
fi

log_success "Depend√™ncias OK"

# ==============================================================================
# LINT E FORMATA√á√ÉO
# ==============================================================================

log_info "Executando verifica√ß√µes de c√≥digo..."

# Executar ESLint
if npm run lint > /dev/null 2>&1; then
    log_success "Lint passou"
else
    log_error "Lint falhou"
    log_info "Execute 'npm run lint:fix' para corrigir automaticamente"
    exit 1
fi

# Verificar formata√ß√£o com Prettier
if npm run format:check > /dev/null 2>&1; then
    log_success "Formata√ß√£o OK"
else
    log_warning "C√≥digo n√£o est√° formatado corretamente"
    log_info "Execute 'npm run format' para formatar o c√≥digo"
    
    # Perguntar se deve continuar
    read -p "Continuar mesmo assim? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ==============================================================================
# TESTES
# ==============================================================================

log_info "Executando testes..."

# Executar testes unit√°rios
if npm run test:ci > /dev/null 2>&1; then
    log_success "Testes unit√°rios passaram"
else
    log_error "Testes unit√°rios falharam"
    log_info "Execute 'npm test' para ver detalhes dos erros"
    
    # Para branches que n√£o s√£o main, permitir continuar
    if [ "$current_branch" != "main" ]; then
        read -p "Continuar mesmo com testes falhando? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        exit 1
    fi
fi

# ==============================================================================
# VERIFICA√á√ïES DE SEGURAN√áA
# ==============================================================================

log_info "Executando verifica√ß√µes de seguran√ßa..."

# Auditoria de depend√™ncias
npm_audit_output=$(npm audit --audit-level=moderate --json 2>/dev/null)
if [ $? -eq 0 ]; then
    vulnerabilities=$(echo "$npm_audit_output" | grep -o '"vulnerabilities":[0-9]*' | grep -o '[0-9]*')
    if [ "$vulnerabilities" -gt 0 ]; then
        log_warning "Encontradas $vulnerabilities vulnerabilidades de seguran√ßa"
        log_info "Execute 'npm audit fix' para corrigir"
        
        read -p "Continuar mesmo assim? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        log_success "Auditoria de seguran√ßa OK"
    fi
else
    log_success "Auditoria de seguran√ßa OK"
fi

# ==============================================================================
# VERIFICAR BUILD (PARA BRANCHES IMPORTANTES)
# ==============================================================================

if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    log_info "Verificando se o projeto compila..."
    
    if npm run build > /dev/null 2>&1; then
        log_success "Build OK"
        # Limpar build de teste
        rm -rf build/ dist/ .expo/ 2>/dev/null
    else
        log_error "Build falhou"
        log_info "Execute 'npm run build' para ver detalhes dos erros"
        exit 1
    fi
fi

# ==============================================================================
# VERIFICA√á√ïES ESPEC√çFICAS DO PROJETO
# ==============================================================================

# Verificar se arquivos cr√≠ticos existem
critical_files=("App.js" "package.json" "app.json" "src/config/supabase.js")
for file in "${critical_files[@]}"; do
    if [ ! -f "$file" ]; then
        log_error "Arquivo cr√≠tico n√£o encontrado: $file"
        exit 1
    fi
done

log_success "Arquivos cr√≠ticos OK"

# Verificar se n√£o h√° imports de desenvolvimento em produ√ß√£o
if grep -r "console.log\|debugger\|TODO\|FIXME" src/ --exclude-dir=__tests__ > /dev/null 2>&1; then
    log_warning "Encontrados console.log, debugger, TODO ou FIXME no c√≥digo"
    
    if [ "$current_branch" = "main" ]; then
        log_error "N√£o √© permitido fazer push para main com debug code"
        exit 1
    else
        read -p "Continuar mesmo assim? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

# ==============================================================================
# VERIFICAR COMMITS
# ==============================================================================

log_info "Verificando qualidade dos commits..."

# Verificar se h√° commits com mensagens muito curtas
recent_commits=$(git log --oneline -5 --pretty=format:"%s")
while IFS= read -r commit_msg; do
    if [ ${#commit_msg} -lt 10 ]; then
        log_warning "Commit com mensagem muito curta: '$commit_msg'"
    fi
done <<< "$recent_commits"

# Verificar se segue conventional commits (b√°sico)
if ! echo "$recent_commits" | head -1 | grep -E "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+" > /dev/null; then
    log_warning "√öltimo commit n√£o segue padr√£o Conventional Commits"
    log_info "Formato esperado: tipo(escopo): descri√ß√£o"
fi

# ==============================================================================
# VERIFICA√á√ïES DE PERFORMANCE
# ==============================================================================

# Verificar tamanho do bundle (se aplic√°vel)
if [ -f "bundle-analyzer-report.html" ]; then
    bundle_size=$(stat -f%z "bundle-analyzer-report.html" 2>/dev/null || stat -c%s "bundle-analyzer-report.html" 2>/dev/null)
    if [ "$bundle_size" -gt 10485760 ]; then # 10MB
        log_warning "Bundle muito grande: $(($bundle_size / 1024 / 1024))MB"
    fi
fi

# ==============================================================================
# VERIFICA√á√ïES FINAIS
# ==============================================================================

# Para branches de feature, verificar se est√° atualizada com develop
if [[ "$current_branch" =~ ^(feature|feat)/.* ]]; then
    log_info "Verificando se branch est√° atualizada com develop..."
    
    git fetch origin develop > /dev/null 2>&1
    commits_behind=$(git rev-list --count HEAD..origin/develop)
    
    if [ "$commits_behind" -gt 10 ]; then
        log_warning "Branch est√° $commits_behind commits atr√°s de develop"
        log_info "Considere fazer rebase: git rebase origin/develop"
        
        read -p "Continuar mesmo assim? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

# ==============================================================================
# NOTIFICA√á√ïES (OPCIONAL)
# ==============================================================================

# Se existe webhook para notifica√ß√µes, usar
if [ -n "$SLACK_WEBHOOK" ] && [ "$current_branch" = "main" ]; then
    curl -X POST -H 'Content-type: application/json' \
         --data "{\"text\":\"üöÄ Push para main realizado por $(git config user.name)\"}" \
         "$SLACK_WEBHOOK" > /dev/null 2>&1 || true
fi

# ==============================================================================
# CONCLUS√ÉO
# ==============================================================================

log_success "Todas as verifica√ß√µes passaram!"
log_info "Push ser√° realizado para branch: $current_branch"

# Mostrar resumo dos commits que ser√£o enviados
log_info "Commits que ser√£o enviados:"
git log --oneline -3 --color=always | sed 's/^/  /'

exit 0
